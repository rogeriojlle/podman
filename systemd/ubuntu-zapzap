# -- Stage de Build --
# Esta etapa inclui as ferramentas necessárias para compilar os pacotes
FROM localhost/ubuntu-base AS build-stage

# Instalação do Node.js
RUN curl -sfL 'https://nodejs.org/dist/v22.17.1/node-v22.17.1-linux-x64.tar.xz' | tar -xJ --strip-components=1 -C /usr/local

# Instalação dos pacotes de desenvolvimento necessários
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  build-essential git python3 libsystemd-dev unzip

# Download do Chromium em /opt
RUN curl -sfLl https://download-chromium.appspot.com/dl/Linux_x64?type=snapshots -o /tmp/chromium.zip
RUN unzip /tmp/chromium.zip -d /opt/

# Configuração do ambiente de trabalho
WORKDIR /opt/zapzap

# Instalação das dependências
RUN npm init -y && npm install whatsapp-web.js qrcode polka sd-notify

# --- Stage Final ---
# Esta etapa é a imagem final, otimizada para rodar a aplicação
FROM localhost/ubuntu-base AS final-stage

# Copia o Node.js da imagem de build
COPY --from=build-stage /usr/local /usr/local

# Instalação das dependências de runtime
RUN curl -sfL https://raw.githubusercontent.com/Xpra-org/xpra/master/packaging/repos/noble/xpra.sources -o /etc/apt/sources.list.d/xpra.sources
RUN curl -sfL https://xpra.org/gpg.asc -o /usr/share/keyrings/xpra.asc

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
  fonts-liberation libappindicator3-1 libasound2t64 libatk-bridge2.0-0t64 libatk1.0-0t64 libcairo2 \
  libcups2t64 libdbus-1-3 libdrm2 libexpat1 libfontconfig1 libgbm1 libgcc-s1 libglib2.0-0t64 \
  libgtk-3-0t64 libnspr4 libnss3 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
  libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxshmfence1 libxtst6 xdg-utils \
  xserver-xorg-video-dummy xpra

RUN useradd -d /opt/zapzap -m -r zapzap

# Ajustes e configurações finais
WORKDIR /opt/zapzap
COPY --exclude=.wwebjs_auth zapzap/opt/zapzap/ /opt/zapzap/
RUN chmod +x ./xpra-service.sh

# Desabilita serviços desnecessarios
RUN systemctl disable onboot.service \
  && systemctl disable firstboot.service \
  && systemctl disable xpra-server.socket \
  && systemctl disable systemd-resolved.service \
  && systemctl disable cups.service

# remove o menu flutuante na página web do xpra
RUN echo 'floating_menu = no' >> /etc/xpra/html5-client/default-settings.txt

# Copia arquivos de configuração do sistema e habilita serviços
COPY zapzap/etc/ /etc/
RUN systemctl enable xpra.service \
  && systemctl enable zapzap.service \
  && systemctl enable api.service \
  && systemctl set-default xpra-zapzap.target

# Copia os módulos Node.js da imagem de build
COPY --from=build-stage /opt/zapzap /opt/zapzap

# Copia o Chromium descompactado da imagem de build
COPY --from=build-stage /opt/chrome-linux /opt/chrome-linux

# Limpeza final
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*
RUN npm cache clean --force
RUN rm -rf ~/.npm /tmp/*

EXPOSE 10000 6789